<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KJP Stock Manager (V.6 Filtered)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Sticky Header for Table */
        .table-container { overflow-x: auto; max-height: 72vh; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        thead th { position: sticky; top: 0; background-color: #1e293b; color: white; z-index: 10; white-space: nowrap; font-size: 0.85rem; padding: 12px;}

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-flex; items-center; gap: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-available { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; } 
        .status-reserved { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; } 
        .status-ad { background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74; } 

        /* Tabs */
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .tab-btn { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
        
        /* YR Badge */
        .yr-badge { background-color: #f1f5f9; color: #475569; font-weight: 600; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #cbd5e1; }
    </style>
</head>
<body class="pb-10 bg-slate-50">

    <div class="bg-white shadow-sm sticky top-0 z-30 px-4 py-3 border-b border-gray-200">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center text-sm"><i class="fas fa-layer-group"></i></span>
                KJP Stock <span class="text-xs text-gray-400 font-normal mt-1">V.6</span>
            </h1>
            <div class="flex gap-2">
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" class="hidden">
                <label for="fileInput" class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow transition active:scale-95">
                    <i class="fas fa-file-import mr-1"></i> Open File
                </label>
            </div>
        </div>
        
        <div id="sheetTabs" class="flex gap-2 mt-3 overflow-x-auto pb-1 max-w-7xl mx-auto hidden no-scrollbar px-1">
            </div>
    </div>

    <div id="controls" class="max-w-7xl mx-auto px-4 py-4 hidden">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 grid grid-cols-2 md:grid-cols-12 gap-3">
            <div class="col-span-2 md:col-span-5 relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search... (Frame, Model, Customer)" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
            </div>
            <div class="col-span-1 md:col-span-3">
                <select id="statusFilter" class="w-full py-2 px-2 border border-gray-200 rounded-lg text-sm bg-white text-gray-600">
                    <option value="">All Status</option>
                    <option value="available">ðŸŸ¢ Available (à¸§à¹ˆà¸²à¸‡)</option>
                    <option value="reserved">ðŸ”´ Reserved (à¸ˆà¸­à¸‡)</option>
                    <option value="ad">ðŸŸ  AD / Demo</option>
                </select>
            </div>
            <div class="col-span-1 md:col-span-3">
                <select id="modelFilter" class="w-full py-2 px-2 border border-gray-200 rounded-lg text-sm bg-white text-gray-600">
                    <option value="">All Models</option>
                </select>
            </div>
            <div class="col-span-2 md:col-span-1">
                 <button onclick="resetFilters()" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition">
                    <i class="fas fa-redo-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-3 mt-4">
            <div class="bg-green-50 border border-green-100 p-3 rounded-xl text-center shadow-sm">
                <div class="text-[10px] text-green-600 font-bold uppercase tracking-wider">Available</div>
                <div class="text-xl font-bold text-green-700 mt-1" id="countAvailable">0</div>
            </div>
            <div class="bg-red-50 border border-red-100 p-3 rounded-xl text-center shadow-sm">
                <div class="text-[10px] text-red-600 font-bold uppercase tracking-wider">Reserved</div>
                <div class="text-xl font-bold text-red-700 mt-1" id="countReserved">0</div>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-3 rounded-xl text-center shadow-sm">
                <div class="text-[10px] text-orange-600 font-bold uppercase tracking-wider">AD / Demo</div>
                <div class="text-xl font-bold text-orange-700 mt-1" id="countAd">0</div>
            </div>
        </div>
    </div>

    <div id="contentArea" class="max-w-7xl mx-auto px-4 pb-20 hidden">
        
        <div class="hidden md:block bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="table-container">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="text-center w-12">#</th>
                            <th>Status</th>
                            <th>Quota</th>
                            <th>KJP</th>
                            <th>Code</th>
                            <th>Model</th>
                            <th>YR</th> <th>Grade</th>
                            <th>Color</th>
                            <th>Frame No.</th>
                            <th>Customer</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm text-gray-700 divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="mobileCardContainer" class="md:hidden space-y-3">
            </div>

        <div id="noData" class="hidden flex flex-col items-center justify-center py-16 text-gray-400">
            <i class="fas fa-filter text-4xl mb-3 opacity-20"></i>
            <p class="text-sm">No data found matching filters</p>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
        <p class="text-gray-500 text-sm font-medium">Processing File...</p>
    </div>

    <script>
        let allSheetsData = {}; 
        let currentSheetName = "";
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const sheetTabs = document.getElementById('sheetTabs');
        const controls = document.getElementById('controls');
        const contentArea = document.getElementById('contentArea');
        const loading = document.getElementById('loading');
        
        const tableBody = document.getElementById('tableBody');
        const mobileCardContainer = document.getElementById('mobileCardContainer');
        const countAvailable = document.getElementById('countAvailable');
        const countReserved = document.getElementById('countReserved');
        const countAd = document.getElementById('countAd');

        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const modelFilter = document.getElementById('modelFilter');

        // Events
        fileInput.addEventListener('change', handleFileUpload);
        searchInput.addEventListener('input', renderCurrentSheet);
        statusFilter.addEventListener('change', renderCurrentSheet);
        modelFilter.addEventListener('change', renderCurrentSheet);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            loading.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                allSheetsData = {};
                sheetTabs.innerHTML = '';
                
                workbook.SheetNames.forEach((sheetName, index) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    
                    // --- CLEAN & FILTER DATA ---
                    const cleanData = jsonData.map(row => {
                        const newRow = {};
                        for (let key in row) newRow[key.trim()] = row[key];
                        return newRow;
                    }).filter(item => {
                        // Logic à¸à¸²à¸£à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸¢à¸°
                        const grade = String(item['GRADE'] || '').trim();
                        const model = String(item['MODEL'] || '').trim();

                        // 1. à¸•à¹‰à¸­à¸‡à¸¡à¸µ MODEL à¹à¸¥à¸° GRADE (à¸–à¹‰à¸² GRADE à¸§à¹ˆà¸²à¸‡ à¹„à¸¡à¹ˆà¹€à¸­à¸²)
                        if (!model || !grade) return false;

                        // 2. à¸à¸£à¸­à¸‡ GRADE à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ à¸«à¸£à¸·à¸­ à¸ªà¸£à¸¸à¸›à¸¢à¸­à¸” (à¹€à¸Šà¹ˆà¸™ "6-1=5", "10 à¸„à¸±à¸™")
                        // à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢à¸•à¸±à¸§à¹€à¸¥à¸‚à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
                        if (/^\d/.test(grade)) return false; 

                        // 3. à¸à¸£à¸­à¸‡à¸„à¸³à¸§à¹ˆà¸² "HYBRID", "HATCHBACK" à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡ GRADE
                        if (grade.toUpperCase().includes('HYBRID')) return false;
                        if (grade.toUpperCase() === 'HATCHBACK') return false;

                        return true;
                    });

                    if (cleanData.length > 0) {
                        allSheetsData[sheetName] = cleanData;
                        
                        const btn = document.createElement('button');
                        btn.className = `tab-btn px-5 py-2 rounded-full text-sm font-medium whitespace-nowrap transition border ${index === 0 ? 'active' : ''}`;
                        btn.innerText = sheetName;
                        btn.onclick = () => switchSheet(sheetName);
                        sheetTabs.appendChild(btn);
                    }
                });

                if (Object.keys(allSheetsData).length > 0) {
                    currentSheetName = Object.keys(allSheetsData)[0];
                    switchSheet(currentSheetName);
                    
                    controls.classList.remove('hidden');
                    sheetTabs.classList.remove('hidden');
                    contentArea.classList.remove('hidden');
                } else {
                    alert("à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰ (à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸·à¹ˆà¸­à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ MODEL, GRADE)");
                }
                loading.classList.add('hidden');
            };
            reader.readAsArrayBuffer(file);
        }

        function switchSheet(sheetName) {
            currentSheetName = sheetName;
            Array.from(sheetTabs.children).forEach(btn => {
                btn.classList.toggle('active', btn.innerText === sheetName);
            });
            populateModelDropdown();
            renderCurrentSheet();
        }

        function getCarStatus(item) {
            const st = String(item['ST'] || '').trim().toUpperCase();
            const remark = String(item['REMARK'] || '').trim().toUpperCase();
            const code = String(item['CODE'] || '').trim().toUpperCase();
            const customer = String(item['CUSTOMER'] || '').trim();

            const isAd = st === 'D' || 
                         st.includes('AD') || st.includes('DEMO') || 
                         remark.includes('AD') || remark.includes('DEMO') || remark.includes('DISPLAY') ||
                         code.includes('AD') || code.includes('DEMO') || code.includes('à¹„à¸¡à¹ˆà¸¡à¸µà¸¥/à¸„') || code.includes('NO CUST');

            if (isAd) return { type: 'ad', text: 'AD / DEMO', class: 'status-ad' };
            if (customer && customer !== '-' && customer.length > 1) return { type: 'reserved', text: 'à¸ˆà¸­à¸‡à¹à¸¥à¹‰à¸§', class: 'status-reserved' };
            return { type: 'available', text: 'à¸§à¹ˆà¸²à¸‡', class: 'status-available' };
        }

        function populateModelDropdown() {
            const data = allSheetsData[currentSheetName] || [];
            const models = [...new Set(data.map(i => i['MODEL']).filter(Boolean))].sort();
            modelFilter.innerHTML = '<option value="">All Models</option>';
            models.forEach(m => modelFilter.innerHTML += `<option value="${m}">${m}</option>`);
        }

        function renderCurrentSheet() {
            const data = allSheetsData[currentSheetName] || [];
            const search = searchInput.value.toLowerCase();
            const statusF = statusFilter.value;
            const modelF = modelFilter.value;

            const filtered = data.filter(item => {
                const status = getCarStatus(item);
                const matchesSearch = Object.values(item).some(val => String(val).toLowerCase().includes(search));
                const matchesStatus = statusF ? status.type === statusF : true;
                const matchesModel = modelF ? item['MODEL'] === modelF : true;
                return matchesSearch && matchesStatus && matchesModel;
            });

            // Update Counts
            let counts = { available: 0, reserved: 0, ad: 0 };
            filtered.forEach(item => {
                const s = getCarStatus(item).type;
                if (counts[s] !== undefined) counts[s]++;
            });
            countAvailable.innerText = counts.available;
            countReserved.innerText = counts.reserved;
            countAd.innerText = counts.ad;

            renderTable(filtered);
            renderCards(filtered);

            document.getElementById('noData').classList.toggle('hidden', filtered.length > 0);
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            data.forEach((item, index) => {
                const status = getCarStatus(item);
                tableBody.innerHTML += `
                    <tr class="hover:bg-blue-50/50 transition border-b border-gray-100 last:border-0 group">
                        <td class="p-4 text-center text-gray-400 text-xs font-mono">${index + 1}</td>
                        <td class="p-4"><span class="status-badge ${status.class}">${status.text}</span></td>
                        <td class="p-4 font-mono text-xs font-bold text-indigo-600">${item['QUOTA'] || '-'}</td>
                        <td class="p-4 font-mono text-xs font-bold text-pink-600">${item['KJP'] || '-'}</td>
                        <td class="p-4 font-mono text-xs text-gray-500">${item['CODE'] || '-'}</td>
                        <td class="p-4 font-medium text-gray-800">${item['MODEL'] || '-'}</td>
                        <td class="p-4"><span class="yr-badge">${item['YR'] || '-'}</span></td> <td class="p-4 text-gray-600">${item['GRADE'] || '-'}</td>
                        <td class="p-4 text-gray-600">${item['CLR'] || '-'}</td>
                        <td class="p-4 font-mono text-xs bg-gray-100 rounded px-2 py-1 w-fit select-all text-blue-600 cursor-pointer hover:bg-blue-100" onclick="navigator.clipboard.writeText('${item['FRAME NUMBER']}')">${item['FRAME NUMBER'] || '-'}</td>
                        <td class="p-4 text-sm font-medium text-gray-700">${item['CUSTOMER'] || '-'}</td>
                        <td class="p-4 text-xs text-gray-400 max-w-[180px] truncate group-hover:whitespace-normal group-hover:overflow-visible group-hover:bg-white group-hover:z-20 group-hover:shadow-md group-hover:rounded group-hover:p-2 transition" title="${item['REMARK'] || ''}">${item['REMARK'] || '-'}</td>
                    </tr>
                `;
            });
        }

        function renderCards(data) {
            mobileCardContainer.innerHTML = '';
            data.forEach(item => {
                const status = getCarStatus(item);
                mobileCardContainer.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg leading-tight">${item['MODEL'] || 'Unknown'} <span class="yr-badge ml-1 text-xs align-middle">YR ${item['YR'] || '?'}</span></h3>
                                <div class="text-sm text-slate-500 mt-1">${item['GRADE'] || '-'} â€¢ ${item['CLR'] || '-'}</div>
                            </div>
                            <span class="status-badge ${status.class}">${status.text}</span>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <div class="text-center">
                                <div class="text-[9px] text-gray-400 font-bold uppercase">Quota</div>
                                <div class="font-mono text-xs font-bold text-indigo-600">${item['QUOTA'] || '-'}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[9px] text-gray-400 font-bold uppercase">KJP</div>
                                <div class="font-mono text-xs font-bold text-pink-600">${item['KJP'] || '-'}</div>
                            </div>
                            <div class="text-center border-l border-slate-200">
                                <div class="text-[9px] text-gray-400 font-bold uppercase">Code</div>
                                <div class="font-mono text-xs text-gray-600">${item['CODE'] || '-'}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[9px] text-gray-400 font-bold uppercase">ST</div>
                                <div class="font-mono text-xs text-gray-600">${item['ST'] || '-'}</div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center text-sm gap-3 bg-white border border-gray-100 p-2 rounded">
                                <i class="fas fa-barcode text-gray-300"></i>
                                <span class="font-mono text-slate-600 select-all">${item['FRAME NUMBER'] || '-'}</span>
                            </div>
                            <div class="flex items-start text-sm gap-3 px-2">
                                <i class="fas fa-user text-gray-300 mt-1"></i>
                                <span class="font-medium text-slate-700">${item['CUSTOMER'] || '-'}</span>
                            </div>
                             ${item['REMARK'] ? `
                                <div class="flex items-start text-xs text-orange-400 gap-3 px-2 mt-1">
                                    <i class="fas fa-info-circle mt-0.5"></i>
                                    <span>${item['REMARK']}</span>
                                </div>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function resetFilters() {
            searchInput.value = '';
            statusFilter.value = '';
            modelFilter.value = '';
            renderCurrentSheet();
        }
    </script>
</body>
</html>
